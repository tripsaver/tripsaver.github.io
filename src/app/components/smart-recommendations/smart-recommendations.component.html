<section class="smart-recommendations-section">
  <div class="container">
    <!-- ğŸ“± MOBILE MENU TOGGLE (Show only on mobile) -->
    <div class="mobile-menu-header">
      <button 
        class="hamburger-button"
        (click)="toggleMobileMenu()"
        [class.active]="mobileMenuOpen"
        aria-label="Toggle menu">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
      <h3 class="mobile-title">ğŸ¤– Trip Finder</h3>
    </div>

    <!-- ğŸ“± MOBILE MENU (Dropdown when opened) -->
    <div class="mobile-menu" *ngIf="mobileMenuOpen">
      <p class="mobile-menu-subtitle">Select your travel preferences</p>
    </div>

    <!-- FILTER SECTION (Only show if showForm is true) -->
    <div class="filters" *ngIf="showForm">
      <h2>ğŸ¤– AI-Powered Destination Finder</h2>
      <p class="subtitle">
        Personalized destination recommendations based on timing, budget, interests, and climate preferences.
      </p>

      <div class="filter-row">
        <div class="filter-group">
          <label for="month">ğŸ“… When are you traveling?</label>
          <select 
            id="month"
            [(ngModel)]="preferences.month" 
            [disabled]="areInputsDisabled()"
            class="form-input">
            <option [value]="1">January</option>
            <option [value]="2">February</option>
            <option [value]="3">March</option>
            <option [value]="4">April</option>
            <option [value]="5">May</option>
            <option [value]="6">June</option>
            <option [value]="7">July</option>
            <option [value]="8">August</option>
            <option [value]="9">September</option>
            <option [value]="10">October</option>
            <option [value]="11">November</option>
            <option [value]="12">December</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="budget">ğŸ’° Budget range</label>
          <select 
            id="budget"
            [(ngModel)]="preferences.budget" 
            [disabled]="areInputsDisabled()"
            class="form-input">
            <option value="budget">Budget (â‚¹10k-20k)</option>
            <option value="moderate">Moderate (â‚¹15k-30k)</option>
            <option value="premium">Premium (â‚¹30k+)</option>
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label>ğŸ¯ What interests you?</label>
        <div class="categories">
          <label *ngFor="let cat of availableCategories" class="category-pill">
            <input 
              type="checkbox" 
              [checked]="preferences.categories.includes(cat)"
              [disabled]="areInputsDisabled()"
              (change)="toggleCategory(cat)">
            <span>{{ cat }}</span>
          </label>
        </div>
      </div>

      <!-- âœ… EXPLICIT ACTION BUTTON -->
      <button 
        (click)="getRecommendations()" 
        [disabled]="isButtonDisabled()"
        class="get-recommendations-btn"
        [class.loading]="uiState.loading">
        {{ getButtonLabel() }}
      </button>
    </div>
  </div>

  <!-- RESULTS SECTION -->
  <div class="results" *ngIf="!uiState.loading && recommendations.length > 0">
    <!-- Results Title -->
    <div class="results-header">
      <h3>âœ¨ Recommended for You</h3>
    </div>

    <!-- Result Summary -->
    <app-result-summary
      [month]="preferences.month"
      [budget]="preferences.budget"
      [categories]="preferences.categories"
      [resultCount]="recommendations.length">
    </app-result-summary>

    <!-- RECOMMENDATIONS CARDS (Always full width) -->
    <div class="cards-container">
      <!-- Each card - clean, no inline expansion -->
      <div *ngFor="let rec of (recommendations | slice:0:6)" class="card-with-itinerary">
        <!-- Destination Card -->
        <app-destination-card-compact
          [recommendation]="rec"
          (bookingClicked)="openBookingModal($event)"
          (planTripClicked)="openItinerary($event)">
        </app-destination-card-compact>
      </div>
    </div>
  </div>

  <!-- ğŸ¯ SIDE DRAWER (Desktop: Right panel, Mobile: Bottom sheet) -->
  <div class="itinerary-drawer" [class.open]="isDrawerOpen">
    <!-- Drawer Overlay (tap to close) -->
    <div class="drawer-overlay" (click)="closeItinerary()"></div>

    <!-- Drawer Panel -->
    <div class="drawer-panel">
      <!-- âœ… HERO IMAGE HEADER (Image-first drawer) -->
      <div class="drawer-hero-image" *ngIf="drawerDestination" [ngStyle]="getDrawerHeaderBackground()">
        <button class="drawer-close-btn" (click)="closeItinerary()">âœ•</button>
      </div>

      <!-- Drawer Header (Content below image) -->
      <div class="drawer-header" *ngIf="drawerDestination">
        <div class="header-content">
          <h2>{{drawerDestination.destination.state}}</h2>
          <p class="trip-duration" *ngIf="drawerMode === 'itinerary'">{{selectedDays}}-Day Itinerary</p>
          <p class="trip-duration" *ngIf="drawerMode === 'explore'">Explore Region</p>
        </div>
      </div>

      <!-- Day Selector Pills (Only show in itinerary mode) -->
      <div class="day-selector" *ngIf="!itineraryLoading && drawerMode === 'itinerary'">
        <button 
          *ngFor="let days of [3, 4, 5, 7]"
          class="day-pill"
          [class.active]="selectedDays === days"
          (click)="onDaySelected(days)">
          {{days}} Days
        </button>
      </div>

      <!-- Loading State -->
      <div *ngIf="itineraryLoading" class="drawer-loading">
        <div class="spinner"></div>
        <p>Generating your itinerary...</p>
      </div>

      <!-- ============ ITINERARY MODE ============ -->
      <div *ngIf="!itineraryLoading && drawerMode === 'itinerary' && activeItinerary" class="drawer-content">
        <div class="itinerary-days">
          <div *ngFor="let day of activeItinerary.itinerary" class="day-item">
            <div class="day-header">
              <span class="day-number">{{day.day}}</span>
              <span class="day-title">{{day.title}}</span>
            </div>
            <div class="day-content expanded">
              <p class="day-description">{{day.description}}</p>
              <div *ngIf="day.places && day.places.length > 0" class="places">
                <div class="section-title">Places to visit</div>
                <ul>
                  <li *ngFor="let place of day.places">{{place}}</li>
                </ul>
              </div>
              <div *ngIf="day.activities && day.activities.length > 0" class="activities">
                <div class="section-title">Activities</div>
                <div class="activity-list">
                  <span *ngFor="let activity of day.activities" class="activity-item">{{activity}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CTA Buttons (Sticky Footer) -->
        <div class="drawer-ctas">
          <button class="cta-btn hotels" (click)="openHotelBooking()">ğŸ¨ Book Hotels</button>
          <button class="cta-btn bus" (click)="openBusBooking()">ğŸšŒ Book Bus</button>
          <button class="cta-btn essentials" (click)="openEssentialsShopping()">ğŸ§³ Buy Essentials</button>
        </div>
      </div>

      <!-- ============ EXPLORE MODE (No itinerary for this state-level destination) ============ -->
      <div *ngIf="!itineraryLoading && drawerMode === 'explore'" class="drawer-explore-state">
        <div class="explore-state-content">
          <p class="explore-icon">ğŸ—ºï¸</p>
          <p class="explore-message">Explore {{drawerDestination?.destination?.state}}</p>
          <p class="explore-hint">This is a region. Select a specific destination to view detailed itinerary</p>
          <button class="explore-cta" (click)="closeItinerary()">â† Back to Results</button>
        </div>
      </div>

      <!-- Empty/Error State - when something goes wrong -->
      <div *ngIf="!itineraryLoading && drawerMode === 'itinerary' && !activeItinerary" class="drawer-empty-state">
        <div class="empty-state-content">
          <p class="empty-icon">âš ï¸</p>
          <p class="empty-message">Unable to load itinerary</p>
          <p class="empty-hint">Try selecting a different duration or destination</p>
        </div>
      </div>
    </div>
  </div>

  <!-- LOADING STATE (Outside .container) -->
  <div *ngIf="uiState.loading" class="loading-state">
    <div class="spinner"></div>
    <p>Finding perfect destinations for you...</p>
  </div>

  <!-- ERROR STATE (Outside .container) -->
  <div *ngIf="uiState.error" class="error-message">
    âš ï¸ {{ uiState.error }}
  </div>

  <!-- EMPTY STATE (Outside .container) -->
  <div *ngIf="!uiState.loading && recommendations.length === 0 && !uiState.error && uiState.hasResults" class="helper-state">
    <p>No destinations found. Try adjusting your preferences and search again.</p>
  </div>

  <!-- INITIAL EMPTY STATE (Before any search) (Outside .container) -->
  <div *ngIf="!uiState.loading && recommendations.length === 0 && !uiState.error && !uiState.hasResults" class="empty-state">
    <p>Select your preferences above and click "Get Recommendations" to discover personalized destinations</p>
  </div>
</section>

<!-- Booking Modal -->
<app-booking-modal
  [isOpen]="isBookingModalOpen"
  [destinationName]="selectedDestination?.state || ''"
  [agodaCode]="selectedDestination?.agoda || ''"
  (closed)="closeBookingModal()">
</app-booking-modal>
